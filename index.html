<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· â€” Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ø´Ø®Øµ</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Kufi+Arabic:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f3fbff;
      --card:#ffffff;
      --muted:#6b7b84;
      --primary:#06b6d4;
      --accent:#2563eb;
      --danger:#ef4444;
      --success:#10b981;
      --shadow:0 12px 30px rgba(2,6,23,0.07);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:"Noto Kufi Arabic",system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--bg),#eaf8fb);color:#042b31;-webkit-font-smoothing:antialiased}
    .app{width:100%;max-width:980px;margin:0 auto;padding:12px;min-height:100vh}
    header{display:flex;flex-direction:row;align-items:center;justify-content:space-between;gap:10px;padding:12px;border-radius:12px;background:linear-gradient(90deg,var(--primary),var(--accent));color:#fff;box-shadow:var(--shadow);position:sticky;top:0;z-index:40}
    .brand{display:flex;gap:10px;align-items:center;flex:1;min-width:0}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,#07b7d6,#2a65f0);display:flex;align-items:center;justify-content:center;font-weight:900;color:#fff;font-size:18px}
    .title{font-weight:900;font-size:16px;line-height:1}
    .subtitle{font-size:12px;opacity:.95}
    .header-actions{display:flex;gap:8px;align-items:center}
    .badge{background:rgba(255,255,255,0.12);padding:6px 10px;border-radius:999px;font-weight:800;color:#fff;font-size:13px}
    .user-pill{padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.06);font-weight:800}
    .btn, .btn-ghost {min-height:44px; padding:10px 12px;border-radius:10px;font-weight:800;border:0;cursor:pointer}
    .btn{background:linear-gradient(90deg,var(--primary),var(--accent));color:#fff}
    .btn-ghost{background:#fff;color:var(--primary);border:1px solid rgba(6,182,212,0.12)}
    main{margin-top:12px}
    .panel{background:var(--card);border-radius:12px;padding:12px;box-shadow:var(--shadow)}
    .tabs{display:flex;gap:8px;margin-bottom:10px}
    .tab{flex:1;text-align:center;padding:10px;border-radius:10px;background:#f6fbfc;cursor:pointer;font-weight:800;font-size:14px}
    .tab.active{background:linear-gradient(90deg,var(--primary),var(--accent));color:#fff}
    .search-row{display:flex;gap:8px;align-items:center;margin-top:12px;margin-bottom:10px}
    .search-row input{flex:1;height:40px;padding:8px;border-radius:10px;border:1px solid #e6eef7;max-width:420px}
    .add-form{display:flex;flex-direction:column;gap:10px;margin-bottom:12px}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-weight:800;font-size:13px}
    .field input{height:48px;padding:10px;border-radius:10px;border:1px solid #e6eef7;font-size:15px}
    .large-input{height:56px;padding:12px;border-radius:12px;font-size:17px}
    .list{display:flex;flex-direction:column;gap:10px;padding:0;margin:0}
    .item{display:flex;flex-direction:row;justify-content:space-between;align-items:center;padding:12px;border-radius:12px;background:linear-gradient(180deg,#fff,#fbfdff);border:1px solid rgba(8,10,17,0.04)}
    .item-left{display:flex;gap:10px;align-items:center;min-width:0}
    .avatar{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,#06b6d4,#2563eb);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900}
    .meta{min-width:0;overflow:hidden}
    .name{font-weight:900;font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .product{color:var(--muted);font-size:13px;margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .phone{color:var(--muted);font-size:13px;margin-top:4px}
    .due-label{font-weight:800;color:var(--muted);font-size:12px;margin-top:6px}
    .due-large{font-weight:900;font-size:14px;color:#06202a;margin-top:2px}
    .amount{font-weight:900;font-size:14px;text-align:left;color:#06202a}
    .controls{display:flex;gap:8px;align-items:center}
    .btn-delete{background:linear-gradient(180deg,#ff5959,#ff2b2b);border-radius:10px;padding:8px 10px;font-weight:900;color:#fff;border:0;cursor:pointer}
    .btn-detail{background:linear-gradient(180deg,#10b981,#06a763);border-radius:10px;padding:8px 10px;font-weight:900;color:#fff;border:0;cursor:pointer}
    .btn-ghost-small{background:transparent;border:1px solid rgba(6,182,212,0.12);padding:8px;border-radius:8px}
    .backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.55);display:none;align-items:flex-end;justify-content:center;padding:0;z-index:12000}
    .modal{width:100%;height:92vh;background:var(--card);border-top-left-radius:16px;border-top-right-radius:16px;padding:14px;box-shadow:0 -20px 60px rgba(2,6,23,0.18);overflow:auto}
    .payments{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .payment-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:#fbfdff;border:1px solid #eef7fb}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#06202a;color:#fff;padding:10px 14px;border-radius:8px;opacity:0;pointer-events:none;transition:all .25s;z-index:15000}
    .muted-small{color:var(--muted);font-size:13px}
    .warning{color:var(--danger);font-weight:800;font-size:13px;margin-top:6px}
    .totals-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
    .totals-badge{
      background:linear-gradient(180deg,#ffffff,#f6fbfc);
      border-radius:12px;
      padding:10px 12px;
      min-width:160px;
      box-shadow:0 6px 18px rgba(2,6,23,0.06);
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:flex-start;
    }
    .person-tabs{display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
    .person-tab{padding:8px 10px;border-radius:10px;background:#f3f7f9;border:1px solid #e6eef7;cursor:pointer;font-weight:800}
    .person-tab.active{background:linear-gradient(90deg,var(--primary),var(--accent));color:#fff}
    .person-controls{display:flex;gap:8px;align-items:center}
    @media(min-width:720px){
      .modal{width:720px;height:auto;border-radius:12px}
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">Ø£Ù‚</div>
        <div style="min-width:0">
          <div class="title">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·</div>
          <div class="subtitle">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ø¯ÙØ¹Ø§Øª</div>
        </div>
      </div>

      <div class="header-actions" role="toolbar" aria-label="Ø£Ø²Ø±Ø§Ø±">
        <div class="badge">Ù…ØªØ£Ø®Ø±ÙˆÙ†: <strong id="overdueCountHeader">0</strong></div>
        <div id="userPill" class="user-pill">ØºÙŠØ± Ù…Ø³Ø¬Ù„</div>
        <button id="btnOpenAuth" class="btn-ghost">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
        <button id="btnLogout" class="btn-ghost" style="display:none">Ø®Ø±ÙˆØ¬</button>
      </div>
    </header>

    <main id="mainPanel" style="display:none;margin-top:12px">
      <div class="panel" aria-live="polite">
        <div class="totals-row" role="region" aria-label="Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø¨Ø§Ù„Øº">
          <div class="totals-badge" title="Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª" aria-live="polite">
            <div class="totals-label">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø§Ù„ÙƒÙ„ÙŠ</div>
            <div id="totalRemainingAll" class="totals-amount">0.00</div>
            <div class="muted-small">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ø®Ø§Øµ: <strong id="totalCount">0</strong></div>
          </div>
        </div>

        <div class="tabs" role="tablist">
          <div id="tabActive" class="tab active" role="tab" tabindex="0">Ù‚ÙŠØ¯ Ø§Ù„ØªØ³Ø¯ÙŠØ¯</div>
          <div id="tabOverdue" class="tab" role="tab" tabindex="0">Ø§Ù„Ù…ØªØ£Ø®Ø±ÙˆÙ†</div>
        </div>

        <div class="add-form">
          <div class="field">
            <label for="custName">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
            <input id="custName" class="large-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" />
          </div>

          <div class="field">
            <label for="custPhone">Ù‡Ø§ØªÙ Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
            <input id="custPhone" class="large-input" type="tel" placeholder="Ù…Ø«Ø§Ù„: 0591234567" />
          </div>

          <div class="field">
            <label for="prodName">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
            <input id="prodName" class="large-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" />
          </div>

          <div class="field">
            <label for="totalAmt">Ù†Ù‚Ø¯</label>
            <input id="totalAmt" class="large-input" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù†Ù‚Ø¯ÙŠ" />
          </div>

          <div class="field">
            <label for="officialPrice">Ø£Ù‚Ø³Ø§Ø·</label>
            <input id="officialPrice" class="large-input" type="number" placeholder="Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ø·" />
          </div>

          <div class="field">
            <label for="downAmt">Ø§Ù„Ø¯ÙØ¹Ø©</label>
            <input id="downAmt" class="large-input" type="number" placeholder="Ø§Ù„Ø¯ÙØ¹Ø©" />
          </div>

          <div class="field">
            <label for="dueDate">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</label>
            <input id="dueDate" class="large-input" type="date" />
          </div>

          <div style="display:flex;justify-content:flex-end">
            <button id="btnAdd" class="btn">Ø£Ø¶Ù</button>
          </div>
        </div>

        <div class="search-row" style="justify-content:flex-start">
          <input id="search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„..." aria-label="Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" />
          <button id="searchBtn" class="btn-ghost">Ø¨Ø­Ø«</button>
        </div>

        <div style="margin-top:12px">
          <ul id="listActive" class="list" aria-label="Ù‚ÙŠØ¯ Ø§Ù„ØªØ³Ø¯ÙŠØ¯"></ul>
          <div id="emptyActive" class="muted-small" style="display:none;margin-top:12px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªØ³Ø¯ÙŠØ¯</div>

          <ul id="listOverdue" class="list" aria-label="Ø§Ù„Ù…ØªØ£Ø®Ø±ÙˆÙ†" style="display:none;margin-top:12px"></ul>
          <div id="emptyOverdue" class="muted-small" style="display:none;margin-top:12px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…ØªØ£Ø®Ø±Ø©</div>
        </div>
      </div>
    </main>
  </div>

  <!-- Detail modal: Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· + ÙŠØ¸Ù‡Ø± Ù†Ù…ÙˆØ°Ø¬ Ù…Ø¹ Ø­Ù‚Ù„ Ø§Ù„Ø§Ø³Ù… Ù…Ø¨Ø§Ø´Ø± (Ø¨Ø¯ÙˆÙ† Ø®ÙŠØ§Ø±Ø§Øª) -->
  <div id="detailBackdrop" class="backdrop" style="display:none">
    <div class="modal" role="dialog" aria-modal="true">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <h3 id="detailTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„</h3>
        <div style="display:flex;gap:8px;align-items:center">
          <div class="person-controls" style="align-items:center">
            <button id="prevPerson" class="btn-ghost-small" title="Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ø³Ø§Ø¨Ù‚">â—€</button>
            <div id="peopleTabs" class="person-tabs" aria-live="polite" style="min-width:220px"></div>
            <button id="nextPerson" class="btn-ghost-small" title="Ø§Ù„Ø´Ø®Øµ Ø§Ù„ØªØ§Ù„ÙŠ">â–¶</button>
            <button id="addPersonBtn" class="btn-ghost-small" title="Ø¥Ø¶Ø§ÙØ© Ø´Ø®Øµ">ï¼‹</button>
          </div>
          <button id="closeDetail" class="btn-ghost">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
          <select id="personSelect" style="flex:1;height:44px;border-radius:8px;border:1px solid #e6eef7;padding:8px"></select>
          <button id="editPersonToggle" class="btn-ghost-small">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´Ø®Øµ</button>
          <button id="deletePersonBtn" class="btn-ghost-small" style="background:transparent;border-color:rgba(239,68,68,0.12);color:var(--danger)">Ø­Ø°Ù Ø´Ø®Øµ</button>
        </div>

        <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¶Ø§ÙØ©/Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø§Ù„Ø§Ø³Ù… Ù‚Ø§Ø¨ÙÙ„ Ù„Ù„Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ø§Ø´Ø±Ø© (Ø¨Ø¯ÙˆÙ† Ø®ÙŠØ§Ø±) -->
        <div id="personEditArea" style="display:none;border:1px dashed #e6eef7;padding:12px;border-radius:10px;margin-bottom:12px">
          <div class="field"><label>Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ</label><input id="personNameInput" class="large-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ" /></div>
          <div class="field"><label>Ù‡Ø§ØªÙ</label><input id="personPhoneInput" class="large-input" /></div>
          <div class="field"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label><input id="personProdInput" class="large-input" /></div>
          <div class="field"><label>Ù†Ù‚Ø¯</label><input id="personCashInput" class="large-input" type="number" /></div>
          <div class="field"><label>Ø£Ù‚Ø³Ø§Ø·</label><input id="personInstallmentsInput" class="large-input" type="number" /></div>
          <div class="field"><label>Ø§Ù„Ø¯ÙØ¹Ø©</label><input id="personDownInput" class="large-input" type="number" /></div>
          <div class="field"><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</label><input id="personDueInput" class="large-input" type="date" /></div>

          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
            <button id="savePersonBtn" class="btn">Ø­ÙØ¸ Ø§Ù„Ø´Ø®Øµ</button>
            <button id="cancelPersonEditBtn" class="btn-ghost">Ø¥Ù„ØºØ§Ø¡</button>
          </div>
        </div>

        <div class="muted-small">Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
        <div id="d_name" style="font-weight:900;margin-top:6px"></div>

        <div class="muted-small" style="margin-top:10px">Ø§Ù„Ù‡Ø§ØªÙ</div>
        <div id="d_phone" style="margin-top:6px;color:var(--muted);font-weight:800">-</div>

        <div class="muted-small" style="margin-top:10px">Ø§Ù„Ù…Ù†ØªØ¬</div>
        <div id="d_product" style="margin-top:6px"></div>

        <div style="margin-top:12px">
          <div class="muted-small">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</div><div id="d_due" class="due-large" style="margin-top:6px">-</div>

          <div class="muted-small" style="margin-top:10px">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ (Ø£Ù‚Ø³Ø§Ø·)</div><div id="d_total" style="font-weight:900;margin-top:6px"></div>
          <div class="muted-small" style="margin-top:10px">Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©</div><div id="d_down" style="margin-top:6px"></div>

          <div class="muted-small" style="margin-top:10px">Ù†Ù‚Ø¯</div>
          <div id="d_official" style="margin-top:6px;font-weight:900"></div>

          <div class="muted-small" style="margin-top:10px">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div><div id="d_remaining" style="font-weight:900;margin-top:6px;color:var(--danger)"></div>
          <div class="progress" style="margin-top:8px"><i id="d_progress" style="width:0%;display:block;height:8px;background:linear-gradient(90deg,#06b6d4,#2563eb);border-radius:999px"></i></div>
        </div>

        <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center">
          <div class="muted-small">Ø§Ù„Ø¯ÙØ¹Ø§Øª</div>
          <div id="paymentsCount" class="muted-small"></div>
        </div>
        <div id="paymentsList" class="payments" style="margin-top:10px"></div>

        <div style="margin-top:12px;display:flex;gap:8px;flex-direction:column">
          <div style="display:flex;gap:8px">
            <input id="payAmount" placeholder="Ù…Ø¨Ù„Øº Ø§Ù„Ø¯ÙØ¹Ø©" type="number" style="flex:1;height:48px;padding:8px;border-radius:8px;border:1px solid #e6eef7" />
            <input id="payDate" type="date" style="width:140px;height:48px;padding:8px;border-radius:8px;border:1px solid #e6eef7" />
          </div>
          <div id="payWarning" class="warning" style="display:none">Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ø§ ÙŠÙƒÙÙŠ Ø£Ùˆ Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
        </div>

        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <button id="savePay" class="btn-detail">Ø­ÙØ¸</button>
          <button id="editFromDetail" class="btn-ghost-small">ØªØ¹Ø¯ÙŠÙ„ (Ø§Ù„Ø³Ø¬Ù„)</button>
          <button id="deleteRec" class="btn-delete">Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" aria-live="polite" style="opacity:0"></div>

  <!-- Firebase libs (Ù…Ø«Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // Firebase config (ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© â€” Ø¥Ù† Ø£Ø±Ø¯Øª Ø¥Ø²Ø§Ù„ØªÙ‡ Ù„Ù„Ø¹Ù…Ù„ Ù…Ø­Ù„ÙŠ Ø§ØªØ±ÙƒÙ‡ ÙƒÙ…Ø§ Ù‡Ùˆ)
    const firebaseConfig = {
      apiKey: "AIzaSyCUe4KjsenF2RRTBYx7CvO2DyGJpQkuHPY",
      authDomain: "hadi-2f066.firebaseapp.com",
      projectId: "hadi-2f066",
      storageBucket: "hadi-2f066.appspot.com",
      messagingSenderId: "784894721054",
      appId: "1:784894721054:web:c66f97e63fa449cde7820f"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(()=>{});

    // Helpers
    const $ = id => document.getElementById(id);
    function showToast(msg, ms=2200){ const t=$('toast'); t.textContent=msg; t.style.opacity=1; clearTimeout(t._h); t._h=setTimeout(()=>t.style.opacity=0,ms); }
    function formatMoney(n){ return Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }
    function genId(prefix='r'){ try{return (crypto && crypto.randomUUID)?crypto.randomUUID():prefix+'_'+Date.now()+'_'+Math.floor(Math.random()*1000000)}catch(e){return prefix+'_'+Date.now()} }
    function escapeHtml(str){ if(!str) return ''; return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
    function normalizeText(s){ if(!s) return ''; return s.toString().toLowerCase().trim().replace(/[\u064B-\u0652\u0670\u06D6-\u06ED]/g,'').replace(/[Ø£Ø¥Ø¢]/g,'Ø§').replace(/Ù‰/g,'ÙŠ').replace(/Ø¤/g,'Ùˆ').replace(/Ø¦/g,'ÙŠ').replace(/Ù€/g,'').replace(/\s+/g,' '); }
    function getSearchTokens(q){ if(!q) return []; return q.split(/\s+/).map(t=> normalizeText(t)).filter(Boolean); }

    const KEY='debt_app_v_mobile';
    function loadLocal(){ try{return JSON.parse(localStorage.getItem(KEY)||'[]')}catch(e){return[]} }
    function saveLocal(v){ localStorage.setItem(KEY, JSON.stringify(v)); }
    let records = loadLocal();
    let currentUser = null;
    let activeDetailId = null;
    let activePersonIndex = 0;
    let isAddingPerson = false;
    let cloudUnsub = null;

    function ensurePeopleOnRecord(rec){
      if(!rec) return;
      if(!rec.people || !Array.isArray(rec.people) || rec.people.length === 0){
        const p = {
          id: genId('pe'),
          customerName: rec.customerName || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
          phone: rec.phone || '',
          productName: rec.productName || '',
          totalAmount: rec.totalAmount || 0,
          officialPrice: rec.officialPrice || 0,
          downPayment: rec.downPayment || 0,
          dueDate: rec.dueDate || '',
          payments: rec.payments ? (Array.isArray(rec.payments) ? rec.payments.slice() : []) : []
        };
        rec.people = [p];
      }
    }

    function updateTotals(){
      let totalRemaining = 0;
      let peopleCount = 0;
      (records||[]).forEach(r=>{
        const people = r.people && r.people.length ? r.people : [{ payments: r.payments || [], totalAmount: r.totalAmount, downPayment: r.downPayment }];
        peopleCount += people.length;
        people.forEach(p=>{
          const paid = (p.payments||[]).reduce((s,pp)=> s + Number(pp.amount), 0);
          const principal = Math.max(0, Number(p.totalAmount||0) - Number(p.downPayment||0));
          const remaining = Math.max(Math.round((principal - paid)*100)/100, 0);
          totalRemaining += remaining;
        });
      });
      if($('totalRemainingAll')) $('totalRemainingAll').textContent = formatMoney(totalRemaining);
      if($('totalCount')) $('totalCount').textContent = peopleCount;
    }

    function renderLists(){
      const q = ($('search').value||'').trim();
      const tokens = getSearchTokens(q);
      const activeList = $('listActive'); activeList.innerHTML='';
      const activeArr = (records||[]).filter(r=>{
        const name = normalizeText((r.people && r.people[0] && r.people[0].customerName) || r.customerName || '');
        if(!tokens.length) return true;
        return tokens.every(t => name.indexOf(t) !== -1);
      });
      $('emptyActive').style.display = activeArr.length ? 'none':'block';
      activeArr.forEach(r=>{
        const mainPerson = (r.people && r.people[0]) ? r.people[0] : { customerName: r.customerName, payments: r.payments || [], totalAmount: r.totalAmount, downPayment: r.downPayment, officialPrice: r.officialPrice, dueDate: r.dueDate };
        const paid = (mainPerson.payments||[]).reduce((s,p)=> s + Number(p.amount),0);
        const principal = Math.max(0, Number(mainPerson.totalAmount||0) - Number(mainPerson.downPayment||0));
        const remaining = Math.max(Math.round((principal-paid)*100)/100,0);
        const li=document.createElement('li'); li.className='item';
        li.innerHTML = `<div class="item-left">
            <div class="avatar">${escapeHtml(((mainPerson.customerName||'--').split(' ').map(s=>s[0]).slice(0,2).join('')).toUpperCase())}</div>
            <div class="meta">
              <div class="name">${escapeHtml(mainPerson.customerName || '-')}</div>
              <div class="product">${escapeHtml(mainPerson.productName || '')} ${mainPerson.officialPrice?(' â€” Ù†Ù‚Ø¯: '+formatMoney(mainPerson.officialPrice)):''}</div>
              ${mainPerson.phone?(`<div class="phone">ğŸ“ ${escapeHtml(mainPerson.phone)}</div>`):''}
              <div class="due-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</div>
              <div class="due-large">${escapeHtml(mainPerson.dueDate||'-')}</div>
            </div>
          </div>
          <div class="controls">
            <div style="text-align:left;margin-left:8px"><div class="amount">${formatMoney(remaining)}</div><div class="muted-small">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div></div>
            <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
              <div style="display:flex;gap:6px">
                <button data-id="${r.id}" data-action="view" class="btn-detail">ØªÙØ§ØµÙŠÙ„</button>
                <button data-id="${r.id}" data-action="edit" class="btn-ghost-small">ØªØ¹Ø¯ÙŠÙ„</button>
              </div>
              <button data-id="${r.id}" data-action="pay" class="btn-ghost-small">Ø¯ÙØ¹Ø©</button>
            </div>
          </div>`;
        activeList.appendChild(li);
      });

      const overdueList = $('listOverdue'); overdueList.innerHTML='';
      const overdueArr = (records||[]).filter(r=>{
        if(!r.people || !r.people.length) ensurePeopleOnRecord(r);
        return r.people.some(p=>{
          if(!p.dueDate) return false;
          const due = new Date(p.dueDate + 'T00:00:00'), today = new Date();
          const diff = Math.floor((today - due)/(1000*60*60*24));
          const paid = (p.payments||[]).reduce((s,pp)=> s + Number(pp.amount),0);
          const principal = Math.max(0, Number(p.totalAmount||0) - Number(p.downPayment||0));
          const remaining = Math.max(Math.round((principal-paid)*100)/100, 0);
          return diff >= 30 && remaining > 0;
        });
      });
      $('emptyOverdue').style.display = overdueArr.length ? 'none':'block';
      overdueArr.forEach(r=>{
        const mainPerson = (r.people && r.people[0]) ? r.people[0] : { customerName: r.customerName, payments: r.payments || [], totalAmount: r.totalAmount, downPayment: r.downPayment, officialPrice: r.officialPrice, dueDate: r.dueDate };
        const paid = (mainPerson.payments||[]).reduce((s,p)=> s + Number(p.amount),0);
        const principal = Math.max(0, Number(mainPerson.totalAmount||0) - Number(mainPerson.downPayment||0));
        const remaining = Math.max(Math.round((principal-paid)*100)/100,0);
        const li=document.createElement('li'); li.className='item';
        li.innerHTML = `<div class="item-left">
            <div class="avatar" style="background:linear-gradient(135deg,#ff7a7a,#ff4d4d)">${escapeHtml(((mainPerson.customerName||'--').split(' ').map(s=>s[0]).slice(0,2).join('')).toUpperCase())}</div>
            <div class="meta">
              <div class="name" style="color:var(--danger)">${escapeHtml(mainPerson.customerName || '-')}</div>
              <div class="product">${escapeHtml(mainPerson.productName || '')} ${mainPerson.officialPrice?(' â€” Ù†Ù‚Ø¯: '+formatMoney(mainPerson.officialPrice)):''}</div>
              ${mainPerson.phone?(`<div class="phone">ğŸ“ ${escapeHtml(mainPerson.phone)}</div>`):''}
              <div class="due-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</div>
              <div class="due-large">${escapeHtml(mainPerson.dueDate||'-')}</div>
            </div>
          </div>
          <div class="controls">
            <div style="text-align:left;margin-left:8px"><div class="amount" style="color:var(--danger)">${formatMoney(remaining)}</div><div class="muted-small">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div></div>
            <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
              <div style="display:flex;gap:6px">
                <button data-id="${r.id}" data-action="view" class="btn-detail">ØªÙØ§ØµÙŠÙ„</button>
                <button data-id="${r.id}" data-action="edit" class="btn-ghost-small">ØªØ¹Ø¯ÙŠÙ„</button>
              </div>
              <button data-id="${r.id}" data-action="pay" class="btn-ghost-small">Ø¯ÙØ¹Ø©</button>
            </div>
          </div>`;
        overdueList.appendChild(li);
      });

      $('overdueCountHeader').textContent = overdueArr.length;
      saveLocal(records);
      updateTotals();
    }

    // Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯ (ÙƒÙ…Ø§ Ø³Ø§Ø¨Ù‚Ø§Ù‹)
    $('btnAdd').addEventListener('click', ()=>{
      const cust = $('custName').value.trim();
      const phone = $('custPhone').value.trim();
      const prod = $('prodName').value.trim();
      const cash = parseFloat($('totalAmt').value||0) || 0;
      const installments = parseFloat($('officialPrice').value);
      const down = parseFloat($('downAmt').value||0);
      const due = $('dueDate').value || null;
      if(!cust || !prod || isNaN(installments) || installments <= 0){ alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­'); return; }
      if(down > installments){ alert('Ø§Ù„Ø¯ÙØ¹Ø© Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…Ø¨Ù„Øº'); return; }
      const firstPerson = {
        id: genId('pe'),
        customerName: cust,
        phone: phone || '',
        productName: prod,
        totalAmount: installments,
        officialPrice: cash,
        downPayment: down || 0,
        dueDate: due,
        payments: []
      };
      const rec = {
        id: genId('r'), customerName: cust, phone: phone || '', productName: prod,
        totalAmount: installments, officialPrice: cash, downPayment: down || 0, dueDate: due,
        payments: [],
        people: [ firstPerson ],
        createdAt: new Date().toISOString(), updatedAt: new Date().toISOString()
      };
      records.unshift(rec); saveLocal(records); renderLists();
      $('custName').value=''; $('custPhone').value=''; $('prodName').value=''; $('totalAmt').value=''; $('officialPrice').value=''; $('downAmt').value=''; $('dueDate').value='';
      showToast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©');
    });

    // Delegated actions for list buttons
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('button');
      if(!btn) return;
      const id = btn.dataset.id, action = btn.dataset.action;
      if(!action) return;
      if(action === 'view'){ openDetail(id); return; }
      if(action === 'pay'){ openDetail(id, true); return; }
      if(action === 'edit'){ openEdit(id); return; }
    });

    // PEOPLE / DETAIL HANDLERS
    function renderPeopleTabsForRecord(rec){
      const tabs = $('peopleTabs');
      tabs.innerHTML = '';
      const select = $('personSelect');
      select.innerHTML = '';
      (rec.people||[]).forEach((p, idx)=>{
        const tab = document.createElement('div');
        tab.className = 'person-tab' + (idx === activePersonIndex ? ' active' : '');
        tab.textContent = p.customerName ? p.customerName : ('Ø´Ø®Øµ ' + (idx+1));
        tab.dataset.idx = idx;
        tab.addEventListener('click', ()=> selectPerson(rec.id, Number(tab.dataset.idx)));
        tabs.appendChild(tab);

        const opt = document.createElement('option');
        opt.value = idx;
        opt.textContent = p.customerName ? p.customerName : ('Ø´Ø®Øµ ' + (idx+1));
        select.appendChild(opt);
      });
      select.value = activePersonIndex;
    }

    function selectPerson(recordId, idx){
      const rec = records.find(r=> r.id === recordId);
      if(!rec || !rec.people) return;
      if(!rec.people[idx]) return;
      activePersonIndex = idx;
      renderPeopleTabsForRecord(rec);
      renderPersonDetails(rec, rec.people[idx]);
    }

    function renderPersonDetails(rec, person){
      if(!person) return;
      $('d_name').textContent = person.customerName || '-';
      $('d_phone').textContent = person.phone || '-';
      $('d_product').textContent = person.productName || '-';
      $('d_due').textContent = person.dueDate || '-';
      $('d_total').textContent = formatMoney(person.totalAmount);
      $('d_down').textContent = formatMoney(person.downPayment||0);
      $('d_official').textContent = person.officialPrice ? formatMoney(person.officialPrice) : '-';
      const paid = (person.payments||[]).reduce((s,p)=> s + Number(p.amount),0);
      const principal = Math.max(0, Number(person.totalAmount||0) - Number(person.downPayment||0));
      const remaining = Math.max(Math.round((principal-paid)*100)/100,0);
      $('d_remaining').textContent = formatMoney(remaining);
      const percent = principal>0? Math.round(((principal-remaining)/principal)*100):0;
      $('d_progress').style.width = Math.min(Math.max(percent,0),100) + '%';

      // payments list
      $('paymentsList').innerHTML = '';
      (person.payments||[]).slice().reverse().forEach(p=>{
        const div = document.createElement('div'); div.className='payment-item';
        div.innerHTML = `<div><strong>${formatMoney(p.amount)}</strong><div style="color:var(--muted)">${escapeHtml(p.date||'')}</div></div><div><button class="btn-ghost-small" data-payid="${p.id}">Ø­Ø°Ù</button></div>`;
        $('paymentsList').appendChild(div);
        div.querySelector('button').addEventListener('click', ()=>{
          if(!confirm('Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙØ¹Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')) return;
          person.payments = (person.payments||[]).filter(pp=> pp.id !== p.id);
          saveLocal(records); renderLists(); openDetail(rec.id); showToast('Ø­ÙØ°ÙØª Ø§Ù„Ø¯ÙØ¹Ø©');
        });
      });
      $('paymentsCount').textContent = (person.payments? person.payments.length:0) + ' Ø¯ÙØ¹Ø§Øª';
      $('payAmount').value = '';
      $('payDate').value = new Date().toISOString().slice(0,10);
      $('payWarning').style.display = 'none';
    }

    function openDetail(id, focusPay=false){
      const r = records.find(x=> x.id === id); if(!r) return;
      activeDetailId = id;
      isAddingPerson = false;
      ensurePeopleOnRecord(r);
      if(typeof activePersonIndex !== 'number' || activePersonIndex < 0 || activePersonIndex >= (r.people||[]).length) activePersonIndex = 0;
      renderPeopleTabsForRecord(r);
      renderPersonDetails(r, r.people[activePersonIndex]);

      $('personSelect').onchange = function(){ selectPerson(r.id, Number(this.value)); };

      // '+' button: Ø¹Ø±Ø¶ Ù†Ù…ÙˆØ°Ø¬ Ù„Ø¥Ø¶Ø§ÙØ© Ø´Ø®Øµ Ø¬Ø¯ÙŠØ¯ â€” Ø§Ù„Ø§Ø³Ù… Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ø§Ø´Ø±Ø©
      $('addPersonBtn').onclick = ()=>{
        isAddingPerson = true;
        const area = $('personEditArea');
        $('personNameInput').value = '';
        $('personPhoneInput').value = '';
        $('personProdInput').value = '';
        $('personCashInput').value = '';
        $('personInstallmentsInput').value = '';
        $('personDownInput').value = '';
        $('personDueInput').value = '';
        area.style.display = 'block';
        setTimeout(()=> $('personNameInput').focus(), 120);
      };

      // Prev/Next
      $('prevPerson').onclick = ()=> {
        const rec = records.find(x=> x.id === id);
        if(!rec || !rec.people) return;
        let newIdx = Math.max(0, activePersonIndex - 1);
        selectPerson(id, newIdx);
      };
      $('nextPerson').onclick = ()=> {
        const rec = records.find(x=> x.id === id);
        if(!rec || !rec.people) return;
        let newIdx = Math.min(rec.people.length - 1, activePersonIndex + 1);
        selectPerson(id, newIdx);
      };

      // ØªØ­Ø±ÙŠØ± Ø´Ø®Øµ Ù…ÙˆØ¬ÙˆØ¯: ÙŠÙØªØ­ Ù†ÙØ³ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù…Ø¹ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ØŒ Ø§Ù„Ø§Ø³Ù… Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø±Ø©
      $('editPersonToggle').onclick = ()=>{
        const area = $('personEditArea');
        if(area.style.display === 'none'){
          isAddingPerson = false;
          const p = r.people[activePersonIndex];
          $('personNameInput').value = p.customerName || '';
          $('personPhoneInput').value = p.phone || '';
          $('personProdInput').value = p.productName || '';
          $('personCashInput').value = p.officialPrice != null ? p.officialPrice : '';
          $('personInstallmentsInput').value = p.totalAmount != null ? p.totalAmount : '';
          $('personDownInput').value = p.downPayment != null ? p.downPayment : '';
          $('personDueInput').value = p.dueDate || '';
          area.style.display = 'block';
          setTimeout(()=> $('personNameInput').focus(), 120);
        } else {
          area.style.display = 'none';
          isAddingPerson = false;
        }
      };

      $('cancelPersonEditBtn').onclick = ()=> { $('personEditArea').style.display = 'none'; isAddingPerson = false; };

      $('savePersonBtn').onclick = ()=>{
        const recx = records.find(x=> x.id === id);
        if(!recx) return;
        const name = $('personNameInput').value.trim();
        const phone = $('personPhoneInput').value.trim();
        const prod = $('personProdInput').value.trim();
        const cash = parseFloat($('personCashInput').value||0) || 0;
        const installments = parseFloat($('personInstallmentsInput').value);
        const down = parseFloat($('personDownInput').value||0) || 0;
        const due = $('personDueInput').value || null;

        // Ø·Ø§Ù„Ù…Ø§ Ø·Ù„Ø¨Øª Ø£Ù† ØªØ¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ù…Ø¨Ø§Ø´Ø±Ø©ØŒ Ù†ÙØ¬Ø¨Ø± Ø¹Ù„Ù‰ ÙˆØ¬ÙˆØ¯Ù‡ Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸
        if(!name || !prod || isNaN(installments) || installments <= 0){
          alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù„Ø´Ø®Øµ (Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù…Ù†ØªØ¬ØŒ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·)'); return;
        }
        if(down > installments){ alert('Ø§Ù„Ø¯ÙØ¹Ø© Ø£ÙƒØ¨Ø± Ù…Ù† Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ø·'); return; }

        if(isAddingPerson){
          const newPerson = {
            id: genId('pe'),
            customerName: name,
            phone: phone || '',
            productName: prod,
            totalAmount: installments,
            officialPrice: cash,
            downPayment: down,
            dueDate: due,
            payments: []
          };
          recx.people = recx.people || [];
          recx.people.push(newPerson);
          recx.updatedAt = new Date().toISOString();
          saveLocal(records);
          isAddingPerson = false;
          activePersonIndex = recx.people.length - 1;
          renderPeopleTabsForRecord(recx);
          selectPerson(recx.id, activePersonIndex);
          $('personEditArea').style.display = 'none';
          showToast('Ø£Ø¶ÙŠÙ Ø´Ø®Øµ Ø¬Ø¯ÙŠØ¯');
          renderLists();
        } else {
          const p = recx.people[activePersonIndex];
          if(!p) return;
          p.customerName = name;
          p.phone = phone || '';
          p.productName = prod;
          p.officialPrice = cash;
          p.totalAmount = installments;
          p.downPayment = down;
          p.dueDate = due;
          recx.updatedAt = new Date().toISOString();
          // Ù„Ùˆ ÙƒØ§Ù† Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ø£ÙˆÙ„ Ù†Ø­Ø¯Ù‘Ø« Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„Ù„Ø³Ø¬Ù„ Ù„ØªØ¨Ù‚Ù‰ Ù…ØªÙˆØ§ÙÙ‚Ø©
          if(activePersonIndex === 0){
            recx.customerName = p.customerName;
            recx.phone = p.phone;
            recx.productName = p.productName;
            recx.totalAmount = p.totalAmount;
            recx.officialPrice = p.officialPrice;
            recx.downPayment = p.downPayment;
            recx.dueDate = p.dueDate;
          }
          saveLocal(records);
          $('personEditArea').style.display = 'none';
          renderPeopleTabsForRecord(recx);
          renderPersonDetails(recx, p);
          showToast('ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®Øµ');
          renderLists();
        }
      };

      $('deletePersonBtn').onclick = ()=>{
        const recx = records.find(x=> x.id === id);
        if(!recx) return;
        if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø´Ø®Øµ Ù…Ù† Ø§Ù„Ø³Ø¬Ù„ØŸ')) return;
        recx.people.splice(activePersonIndex,1);
        if(recx.people.length === 0){
          // Ù„Ø§ Ù†Ø¶ÙŠÙ "Ø´Ø®Øµ 2" ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ â€” Ù†Ø¶Ø¹ Ù†Ø§Ø¦Ø¨ Ø®ÙÙŠÙ
          recx.people.push({
            id: genId('pe'),
            customerName: 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
            phone: '',
            productName: '',
            totalAmount: 0,
            officialPrice: 0,
            downPayment: 0,
            dueDate: '',
            payments: []
          });
        }
        activePersonIndex = Math.min(activePersonIndex, recx.people.length - 1);
        recx.updatedAt = new Date().toISOString();
        saveLocal(records);
        renderPeopleTabsForRecord(recx);
        selectPerson(recx.id, activePersonIndex);
        renderLists();
        showToast('Ø­ÙØ°Ù Ø§Ù„Ø´Ø®Øµ');
      };

      $('deleteRec').onclick = ()=>{
        if(!confirm('Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')) return;
        records = records.filter(rr => rr.id !== activeDetailId);
        saveLocal(records);
        $('detailBackdrop').style.display = 'none';
        renderLists();
        showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„');
      };

      $('editFromDetail').onclick = ()=> openEdit(id);

      $('detailBackdrop').style.display = 'flex';
      if(focusPay) setTimeout(()=> $('payAmount').focus(),160);
    }

    $('closeDetail').addEventListener('click', ()=> { $('detailBackdrop').style.display = 'none'; isAddingPerson = false; });

    // Ø¯ÙØ¹ Ø¯ÙØ¹Ø©
    $('savePay').addEventListener('click', ()=>{
      if(!activeDetailId) return;
      const amt = parseFloat($('payAmount').value); if(isNaN(amt)||amt<=0){ alert('Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„ØºØ§Ù‹ ØµØ­ÙŠØ­Ø§Ù‹'); return; }
      const rec = records.find(r=> r.id === activeDetailId); if(!rec) return;
      ensurePeopleOnRecord(rec);
      const pers = rec.people && rec.people[activePersonIndex];
      if(!pers) return;
      const paid = (pers.payments||[]).reduce((s,p)=> s + Number(p.amount),0);
      const principal = Math.max(0, Number(pers.totalAmount||0) - Number(pers.downPayment||0));
      const remaining = Math.max(Math.round((principal-paid)*100)/100,0);
      if(amt > remaining){ alert('Ø§Ù„Ù…Ø¨Ù„Øº Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ'); return; }
      const date = $('payDate').value || new Date().toISOString().slice(0,10);
      pers.payments = pers.payments || [];
      pers.payments.push({ id: 'p_' + Date.now(), amount: Math.round(amt*100)/100, date });
      rec.updatedAt = new Date().toISOString();
      saveLocal(records);
      renderLists(); openDetail(activeDetailId); showToast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙØ¹Ø©');
    });

    // ØªØ¹Ø¯ÙŠÙ„ Ø³Ø¬Ù„ ÙƒÙ„ÙŠ (ÙŠØ¨Ù‚Ù‰ Ø¨Ø³ÙŠØ·)
    function openEdit(id){
      const r = records.find(x=> x.id === id); if(!r) return;
      ensurePeopleOnRecord(r);
      const main = r.people && r.people[0] ? r.people[0] : { customerName: r.customerName };
      const name = prompt('Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„', main.customerName || '');
      if(name === null) return;
      main.customerName = name.trim() || main.customerName;
      r.customerName = main.customerName;
      r.updatedAt = new Date().toISOString();
      saveLocal(records);
      renderLists();
      showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ø³ÙŠØ·');
    }

    // Ø¨Ø­Ø« Ùˆ debounce
    function debounce(fn, wait){ let h=null; return (...a)=>{ if(h) clearTimeout(h); h=setTimeout(()=>{ fn(...a); h=null; }, wait); }; }
    const debouncedRender = debounce(renderLists, 120);
    $('search').addEventListener('input', debouncedRender);
    $('searchBtn').addEventListener('click', renderLists);

    // backdrop close handling
    document.querySelectorAll('.backdrop').forEach(b=>{
      b.addEventListener('click', (e)=>{
        if(e.target !== b) return;
        b.style.display = 'none';
        if(b.id === 'detailBackdrop') isAddingPerson = false;
      });
      b.querySelectorAll('.modal').forEach(m => m.addEventListener('click', ev => ev.stopPropagation()));
    });

    // init / auth light
    auth.onAuthStateChanged(user=>{
      if(user){
        currentUser = { uid:user.uid, email:user.email, name:user.displayName || (user.email||'').split('@')[0] };
        $('userPill').textContent = currentUser.name;
        $('btnLogout').style.display = 'inline-block';
        $('btnOpenAuth').style.display = 'none';
        $('mainPanel').style.display = 'block';
      } else {
        currentUser = null;
        $('userPill').textContent = 'ØºÙŠØ± Ù…Ø³Ø¬Ù„';
        $('btnLogout').style.display = 'none';
        $('btnOpenAuth').style.display = 'inline-block';
        $('mainPanel').style.display = 'block';
      }
      renderLists();
    });

    // start
    setTimeout(()=> renderLists(), 120);
  </script>
</body>
</html>
```
