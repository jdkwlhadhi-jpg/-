<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· â€” Ù…ÙˆØ¨Ø§ÙŠÙ„</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Kufi+Arabic:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f3fbff;
      --card:#ffffff;
      --muted:#6b7b84;
      --primary:#06b6d4;
      --accent:#2563eb;
      --danger:#ef4444;
      --success:#10b981;
      --shadow:0 12px 30px rgba(2,6,23,0.07);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:"Noto Kufi Arabic",system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--bg),#eaf8fb);color:#042b31;-webkit-font-smoothing:antialiased}
    .app{width:100%;max-width:980px;margin:0 auto;padding:12px;min-height:100vh}
    header{display:flex;flex-direction:row;align-items:center;justify-content:space-between;gap:10px;padding:12px;border-radius:12px;background:linear-gradient(90deg,var(--primary),var(--accent));color:#fff;box-shadow:var(--shadow);position:sticky;top:0;z-index:40}
    .brand{display:flex;gap:10px;align-items:center;flex:1;min-width:0}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,#07b7d6,#2a65f0);display:flex;align-items:center;justify-content:center;font-weight:900;color:#fff;font-size:18px}
    .title{font-weight:900;font-size:16px;line-height:1}
    .subtitle{font-size:12px;opacity:.95}
    .header-actions{display:flex;gap:8px;align-items:center}
    .badge{background:rgba(255,255,255,0.12);padding:6px 10px;border-radius:999px;font-weight:800;color:#fff;font-size:13px}
    .small-badge{background:rgba(255,255,255,0.06);padding:6px 10px;border-radius:10px;font-weight:800;color:#fff;font-size:12px;display:flex;align-items:center;gap:8px}
    .people-badge{background:rgba(0,0,0,0.12);padding:6px 10px;border-radius:999px;font-weight:900;color:#fff;font-size:13px;display:flex;align-items:center;gap:8px;border:0}
    .people-badge svg{opacity:0.98}
    .user-pill{padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.06);font-weight:800}
    .btn, .btn-ghost {min-height:44px; padding:10px 12px;border-radius:10px;font-weight:800;border:0;cursor:pointer}
    .btn{background:linear-gradient(90deg,var(--primary),var(--accent));color:#fff}
    .btn-ghost{background:#fff;color:var(--primary);border:1px solid rgba(6,182,212,0.12)}
    main{margin-top:12px}
    .panel{background:var(--card);border-radius:12px;padding:12px;box-shadow:var(--shadow)}
    .tabs{display:flex;gap:8px;margin-bottom:10px}
    .tab{flex:1;text-align:center;padding:10px;border-radius:10px;background:#f6fbfc;cursor:pointer;font-weight:800;font-size:14px}
    .tab.active{background:linear-gradient(90deg,var(--primary),var(--accent));color:#fff}
    .search-row{display:flex;gap:8px;align-items:center;margin-top:12px;margin-bottom:10px}
    .search-row input{flex:1;height:40px;padding:8px;border-radius:10px;border:1px solid #e6eef7;max-width:420px}
    .add-form{display:flex;flex-direction:column;gap:10px;margin-bottom:12px}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-weight:800;font-size:13px}
    .field input{height:48px;padding:10px;border-radius:10px;border:1px solid #e6eef7;font-size:15px}
    .large{height:56px;padding:12px;font-size:16px}
    .list{display:flex;flex-direction:column;gap:10px;padding:0;margin:0}
    .item{display:flex;flex-direction:row;justify-content:space-between;align-items:center;padding:12px;border-radius:12px;background:linear-gradient(180deg,#fff,#fbfdff);border:1px solid rgba(8,10,17,0.04)}
    .item-left{display:flex;gap:10px;align-items:center;min-width:0}
    .avatar{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,#06b6d4,#2563eb);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900}
    .meta{min-width:0;overflow:hidden}
    .name{font-weight:900;font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .product{color:var(--muted);font-size:13px;margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .phone{color:var(--muted);font-size:13px;margin-top:4px}
    .due-label{font-weight:800;color:var(--muted);font-size:12px;margin-top:6px}
    .due-large{font-weight:900;font-size:14px;color:#06202a;margin-top:2px}
    .amount{font-weight:900;font-size:14px;text-align:left;color:#06202a}
    .controls{display:flex;gap:8px;align-items:center}
    .btn-delete{background:linear-gradient(180deg,#ff5959,#ff2b2b);border-radius:10px;padding:8px 10px;font-weight:900;color:#fff;border:0;cursor:pointer}
    .btn-detail{background:linear-gradient(180deg,#10b981,#06a763);border-radius:10px;padding:8px 10px;font-weight:900;color:#fff;border:0;cursor:pointer}
    .btn-ghost-small{background:transparent;border:1px solid rgba(6,182,212,0.12);padding:8px;border-radius:8px}
    .backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.55);display:none;align-items:flex-end;justify-content:center;padding:0;z-index:12000}
    .modal{width:100%;height:92vh;background:var(--card);border-top-left-radius:16px;border-top-right-radius:16px;padding:14px;box-shadow:0 -20px 60px rgba(2,6,23,0.18);overflow:auto}
    .modal h3{margin:0}
    .payments{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .payment-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:#fbfdff;border:1px solid #eef7fb}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#06202a;color:#fff;padding:10px 14px;border-radius:8px;opacity:0;pointer-events:none;transition:all .25s;z-index:15000}
    .muted-small{color:var(--muted);font-size:13px}
    .warning{color:var(--danger);font-weight:800;font-size:13px;margin-top:6px}
    .totals-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
    .totals-badge{
      background:linear-gradient(180deg,#ffffff,#f6fbfc);
      border-radius:12px;
      padding:10px 12px;
      min-width:160px;
      box-shadow:0 6px 18px rgba(2,6,23,0.06);
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:flex-start;
    }
    .totals-label{font-size:12px;color:var(--muted);font-weight:800}
    .totals-amount{font-size:20px;font-weight:900;color:#06202a}
    .totals-amount.profit-positive{color:var(--success)}
    .totals-amount.profit-negative{color:var(--danger)}
    mark{background:rgba(255,235,59,0.45);padding:0 2px;border-radius:2px}
    @media(min-width:720px){
      header{padding:16px}
      .logo{width:56px;height:56px}
      .avatar{width:56px;height:56px;border-radius:12px}
      .modal{width:720px;height:auto;border-radius:12px}
      .totals-badge{min-width:200px}
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">Ø£Ù‚</div>
        <div style="min-width:0">
          <div class="title">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·</div>
          <div class="subtitle">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ø¯ÙØ¹Ø§Øª</div>
        </div>
      </div>

      <div class="header-actions" role="toolbar" aria-label="Ø£Ø²Ø±Ø§Ø±">
        <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ø®Ø§Øµ -->
        <button id="peopleBtn" class="people-badge" aria-label="Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ø®Ø§Øµ" title="Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ø®Ø§Øµ">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 12a4 4 0 100-8 4 4 0 000 8z" fill="#fff"></path>
            <path d="M3 20a8.5 8.5 0 0118 0v1H3v-1z" fill="#fff"></path>
          </svg>
          <span id="peopleCount">0</span>
        </button>

        <div class="badge">Ù…ØªØ£Ø®Ø±ÙˆÙ†: <strong id="overdueCountHeader">0</strong></div>
        <div id="userPill" class="user-pill">ØºÙŠØ± Ù…Ø³Ø¬Ù„</div>
        <button id="btnOpenAuth" class="btn-ghost">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
        <button id="btnLogout" class="btn-ghost" style="display:none">Ø®Ø±ÙˆØ¬</button>
      </div>
    </header>

    <main id="mainPanel" style="display:none;margin-top:12px">
      <div class="panel" aria-live="polite">
        <div class="totals-row" role="region" aria-label="Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø¨Ø§Ù„Øº">
          <div class="totals-badge" title="Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª">
            <div class="totals-label">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø§Ù„ÙƒÙ„ÙŠ</div>
            <div id="totalRemainingAll" class="totals-amount">0.00</div>
          </div>
        </div>

        <div class="tabs" role="tablist">
          <div id="tabActive" class="tab active" role="tab" tabindex="0">Ù‚ÙŠØ¯ Ø§Ù„ØªØ³Ø¯ÙŠØ¯</div>
          <div id="tabOverdue" class="tab" role="tab" tabindex="0">Ø§Ù„Ù…ØªØ£Ø®Ø±ÙˆÙ†</div>
        </div>

        <div class="add-form">
          <div class="field">
            <label for="custName">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
            <input id="custName" class="large" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" />
          </div>

          <!-- Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ -->
          <div class="field">
            <label for="custPhone">Ù‡Ø§ØªÙ Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
            <input id="custPhone" type="tel" placeholder="Ù…Ø«Ø§Ù„: 0591234567" />
          </div>

          <div class="field">
            <label for="prodName">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
            <input id="prodName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" />
          </div>

          <!-- swapped labels/functionality:
               totalAmt input now represents "Ù†Ù‚Ø¯" (cash)
               officialPrice input now represents "Ø£Ù‚Ø³Ø§Ø·" (installment total)
          -->
          <div class="field">
            <label for="totalAmt">Ù†Ù‚Ø¯</label>
            <input id="totalAmt" class="large" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù†Ù‚Ø¯ÙŠ" />
          </div>

          <div class="field">
            <label for="officialPrice">Ø£Ù‚Ø³Ø§Ø·</label>
            <input id="officialPrice" type="number" placeholder="Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ø·" />
          </div>

          <div class="field">
            <label for="downAmt">Ø§Ù„Ø¯ÙØ¹Ø©</label>
            <input id="downAmt" type="number" placeholder="Ø§Ù„Ø¯ÙØ¹Ø©" />
          </div>

          <div class="field">
            <label for="dueDate">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</label>
            <input id="dueDate" type="date" />
          </div>

          <div style="display:flex;justify-content:flex-end">
            <button id="btnAdd" class="btn">Ø£Ø¶Ù</button>
          </div>
        </div>

        <div class="search-row" style="justify-content:flex-start">
          <input id="search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„..." aria-label="Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" />
          <button id="searchBtn" class="btn-ghost">Ø¨Ø­Ø«</button>
        </div>

        <div style="margin-top:12px">
          <ul id="listActive" class="list" aria-label="Ù‚ÙŠØ¯ Ø§Ù„ØªØ³Ø¯ÙŠØ¯"></ul>
          <div id="emptyActive" class="muted-small" style="display:none;margin-top:12px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªØ³Ø¯ÙŠØ¯</div>

          <ul id="listOverdue" class="list" aria-label="Ø§Ù„Ù…ØªØ£Ø®Ø±ÙˆÙ†" style="display:none;margin-top:12px"></ul>
          <div id="emptyOverdue" class="muted-small" style="display:none;margin-top:12px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…ØªØ£Ø®Ø±Ø©</div>
        </div>
      </div>
    </main>
  </div>

  <!-- Detail modal -->
  <div id="detailBackdrop" class="backdrop" style="display:none">
    <div class="modal" role="dialog" aria-modal="true">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 id="detailTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„</h3>
        <button id="closeDetail" class="btn-ghost">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>

      <div style="margin-top:12px">
        <div class="muted-small">Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
        <div id="d_name" style="font-weight:900;margin-top:6px"></div>

        <div class="muted-small" style="margin-top:10px">Ø§Ù„Ù‡Ø§ØªÙ</div>
        <div id="d_phone" style="margin-top:6px;color:var(--muted);font-weight:800">-</div>

        <div class="muted-small" style="margin-top:10px">Ø§Ù„Ù…Ù†ØªØ¬</div>
        <div id="d_product" style="margin-top:6px"></div>

        <div style="margin-top:12px">
          <div class="muted-small">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</div><div id="d_due" class="due-large" style="margin-top:6px">-</div>

          <div class="muted-small" style="margin-top:10px">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ (Ø£Ù‚Ø³Ø§Ø·)</div><div id="d_total" style="font-weight:900;margin-top:6px"></div>
          <div class="muted-small" style="margin-top:10px">Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©</div><div id="d_down" style="margin-top:6px"></div>

          <div class="muted-small" style="margin-top:10px">Ù†Ù‚Ø¯</div>
          <div id="d_official" style="margin-top:6px;font-weight:900"></div>

          <div class="muted-small" style="margin-top:10px">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div><div id="d_remaining" style="font-weight:900;margin-top:6px;color:var(--danger)"></div>
          <div class="progress" style="margin-top:8px"><i id="d_progress" style="width:0%;display:block;height:8px;background:linear-gradient(90deg,#06b6d4,#2563eb);border-radius:999px"></i></div>
        </div>

        <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center">
          <div class="muted-small">Ø§Ù„Ø¯ÙØ¹Ø§Øª</div>
          <div id="paymentsCount" class="muted-small"></div>
        </div>
        <div id="paymentsList" class="payments" style="margin-top:10px"></div>

        <div style="margin-top:12px;display:flex;gap:8px;flex-direction:column">
          <div style="display:flex;gap:8px">
            <input id="payAmount" placeholder="Ù…Ø¨Ù„Øº Ø§Ù„Ø¯ÙØ¹Ø©" type="number" style="flex:1;height:48px;padding:8px;border-radius:8px;border:1px solid #e6eef7" />
            <input id="payDate" type="date" style="width:140px;height:48px;padding:8px;border-radius:8px;border:1px solid #e6eef7" />
          </div>
          <div id="payWarning" class="warning" style="display:none">Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ø§ ÙŠÙƒÙÙŠ Ø£Ùˆ Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
        </div>

        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <button id="savePay" class="btn-detail">Ø­ÙØ¸</button>
          <button id="deleteRec" class="btn-delete">Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit modal -->
  <div id="editBackdrop" class="backdrop" style="display:none">
    <div class="modal" role="dialog" aria-modal="true">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„</h3>
        <button id="closeEdit" class="btn-ghost">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>

      <div style="margin-top:12px">
        <div class="field">
          <label for="editCustName">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
          <input id="editCustName" />
        </div>
        <div class="field">
          <label for="editCustPhone">Ù‡Ø§ØªÙ Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
          <input id="editCustPhone" type="tel" />
        </div>
        <div class="field">
          <label for="editProdName">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
          <input id="editProdName" />
        </div>

        <!-- same swapped semantics as add form -->
        <div class="field">
          <label for="editTotalAmt">Ù†Ù‚Ø¯</label>
          <input id="editTotalAmt" type="number" />
        </div>
        <div class="field">
          <label for="editOfficialPrice">Ø£Ù‚Ø³Ø§Ø·</label>
          <input id="editOfficialPrice" type="number" />
        </div>
        <div class="field">
          <label for="editDownAmt">Ø§Ù„Ø¯ÙØ¹Ø©</label>
          <input id="editDownAmt" type="number" />
        </div>
        <div class="field">
          <label for="editDueDate">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</label>
          <input id="editDueDate" type="date" />
        </div>

        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <button id="saveEdit" class="btn">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
          <button id="cancelEdit" class="btn-ghost">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Auth & register modals -->
  <div id="authBackdrop" class="backdrop" style="display:flex">
    <div class="modal" role="dialog" aria-modal="true" style="border-radius:12px;max-width:480px;margin:22px;">
      <div style="display:flex;align-items:center;gap:12px;padding:8px 4px;border-bottom:1px solid #eef7fb">
        <div class="logo" style="width:46px;height:46px;border-radius:10px;font-size:18px">Ø£Ù‚</div>
        <div>
          <div style="font-weight:900">Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ</div>
          <div style="font-size:13px;color:var(--muted)">Ø§Ø¯Ø®Ù„ Ø­Ø³Ø§Ø¨Ùƒ Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
        </div>
      </div>

      <div style="padding:12px">
        <div id="authError" class="error" style="display:none"></div>
        <div class="field"><input id="loginEmail" type="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" autocomplete="email" /></div>
        <div class="field" style="margin-top:8px;position:relative">
          <input id="loginPassword" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" autocomplete="current-password" />
          <button id="togglePassword" class="btn-ghost-small" style="position:absolute;left:8px;top:8px;padding:6px">ğŸ‘</button>
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
          <label style="display:flex;gap:8px;align-items:center"><input id="rememberMe" type="checkbox" /> ØªØ°ÙƒÙ‘Ø±Ù†ÙŠ</label>
          <button id="forgotPassword" class="btn-ghost">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±ØŸ</button>
        </div>

        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="doLogin" class="btn" style="flex:1">Ø¯Ø®ÙˆÙ„</button>
          <button id="openRegister" class="btn-ghost" style="flex:1">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
        </div>

        <div style="margin-top:12px;font-size:13px;color:var(--muted)">Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ø¨Ø­Ø³Ø§Ø¨Ùƒ Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø£ÙŠ Ø¬Ù‡Ø§Ø².</div>
      </div>
    </div>
  </div>

  <div id="registerBackdrop" class="backdrop" style="display:none">
    <div class="modal" role="dialog" aria-modal="true">
      <div style="padding:12px">
        <div id="regError" class="error" style="display:none"></div>
        <div id="regInfo" class="info" style="display:none"></div>
        <div class="field">
          <label for="regEmail">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
          <input id="regEmail" type="email" placeholder="example@domain.com" autocomplete="email" />
        </div>
        <div class="field">
          <label for="regDisplayName">Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶</label>
          <input id="regDisplayName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø°ÙŠ Ø³ÙŠØ¸Ù‡Ø±" />
        </div>
        <div class="field">
          <label for="regPassword">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
          <input id="regPassword" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)" />
        </div>
        <div class="field">
          <label for="regPassword2">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
          <input id="regPassword2" type="password" placeholder="Ø£Ø¹Ø¯ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px">
          <button id="closeRegister" class="btn-ghost">Ø¥Ù„ØºØ§Ø¡</button>
          <button id="doRegister" class="btn">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨</button>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" aria-live="polite" style="opacity:0"></div>

  <!-- Firebase libs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCUe4KjsenF2RRTBYx7CvO2DyGJpQkuHPY",
      authDomain: "hadi-2f066.firebaseapp.com",
      projectId: "hadi-2f066",
      storageBucket: "hadi-2f066.appspot.com",
      messagingSenderId: "784894721054",
      appId: "1:784894721054:web:c66f97e63fa449cde7820f"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(()=>{});

    // Helpers
    const $ = id => document.getElementById(id);
    function showToast(msg, ms=2200){ const t=$('toast'); t.textContent=msg; t.style.opacity=1; clearTimeout(t._h); t._h=setTimeout(()=>t.style.opacity=0,ms); }
    function showAuthError(msg){ const el=$('authError'); el.textContent=msg; el.style.display = msg ? 'block':'none'; }
    function showRegError(msg){ const el=$('regError'); el.textContent=msg; el.style.display = msg ? 'block':'none'; }
    function showRegInfo(msg){ const el=$('regInfo'); el.textContent=msg; el.style.display = msg ? 'block':'none'; }
    function formatMoney(n){ return Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }
    function genId(){ try{return (crypto && crypto.randomUUID)?crypto.randomUUID():'r_'+Date.now()+'_'+Math.floor(Math.random()*1000000)}catch(e){return 'r_'+Date.now()} }

    function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

    function escapeHtml(str){
      if(!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function normalizeText(s){
      if(!s) return '';
      return s.toString().toLowerCase().trim()
        .replace(/[\u064B-\u0652\u0670\u06D6-\u06ED]/g,'')
        .replace(/[Ø£Ø¥Ø¢]/g,'Ø§')
        .replace(/Ù‰/g,'ÙŠ')
        .replace(/Ø¤/g,'Ùˆ')
        .replace(/Ø¦/g,'ÙŠ')
        .replace(/Ù€/g,'')
        .replace(/\s+/g,' ');
    }

    function getSearchTokens(q){
      if(!q) return [];
      return q.split(/\s+/).map(t=> normalizeText(t)).filter(Boolean);
    }

    function recordMatches(record, tokens){
      if(!tokens || tokens.length===0) return true;
      const customer = normalizeText(record.customerName || '');
      const words = customer.split(' ').filter(Boolean);
      const first = words.length ? words[0] : '';
      if(!first) return false;
      return tokens.every(token => first.startsWith(token));
    }

    function highlightText(original, tokens){
      if(!original || !tokens || tokens.length===0) return escapeHtml(original || '');
      try{
        const words = original.split(' ');
        const firstWord = words.length ? words[0] : original;
        const rest = words.slice(1).join(' ');
        let highlightedFirst = escapeHtml(firstWord);

        tokens.forEach(token=>{
          if(!token) return;
          const normFirst = normalizeText(firstWord);
          if(normFirst.indexOf(token) === 0){
            const origPrefix = firstWord.slice(0, token.length);
            const escapedPrefix = escapeHtml(origPrefix);
            const re = new RegExp('^' + escapeRegExp(escapedPrefix));
            highlightedFirst = highlightedFirst.replace(re, `<mark>${escapedPrefix}</mark>`);
          }
        });

        return rest ? (highlightedFirst + ' ' + escapeHtml(rest)) : highlightedFirst;
      }catch(e){
        let out = escapeHtml(original);
        tokens.forEach(token=>{
          try{
            if(!token) return;
            const re = new RegExp(escapeRegExp(token), 'ig');
            out = out.replace(re, m => `<mark>${escapeHtml(m)}</mark>`);
          }catch(e){}
        });
        return out;
      }
    }

    function debounce(fn, wait){
      let h = null;
      return function(...args){
        if(h) clearTimeout(h);
        h = setTimeout(()=>{ fn.apply(this,args); h=null; }, wait);
      };
    }

    const KEY='debt_app_v_mobile';
    function loadLocal(){ try{return JSON.parse(localStorage.getItem(KEY)||'[]')}catch(e){return[]} }
    function saveLocal(v){ localStorage.setItem(KEY, JSON.stringify(v)); }
    let records = loadLocal();
    let currentUser = null;
    let activeDetailId = null;
    let editingId = null;
    let cloudUnsub = null;

    function tsToMillis(t){
      if(!t) return 0;
      if(typeof t === 'number') return t;
      if(typeof t === 'string') {
        const p = Date.parse(t);
        return isNaN(p) ? 0 : p;
      }
      if(typeof t.toMillis === 'function') {
        try{ return t.toMillis(); }catch(e){ return 0; }
      }
      return 0;
    }

    function isOverdueBy30(record){
      if(!record || !record.dueDate) return false;
      const due = new Date(record.dueDate + 'T00:00:00'), today = new Date();
      const diff = Math.floor((today - due)/(1000*60*60*24));
      const paid = (record.payments||[]).reduce((s,p)=> s + Number(p.amount), 0);
      const principal = Math.max(0, Number(record.totalAmount||0) - Number(record.downPayment||0));
      const remaining = Math.max(Math.round((principal - paid)*100)/100, 0);

      if(!(diff >= 30 && remaining > 0)) return false;

      const payments = (record.payments||[]).map(p => p && p.date ? p.date : null).filter(Boolean);
      if(payments.length){
        let latest = payments.reduce((a,b) => a > b ? a : b, payments[0]);
        const latestDate = new Date(latest + 'T00:00:00');
        if(!isNaN(latestDate.getTime()) && latestDate > due){
          return false;
        }
      }

      return true;
    }

    function mergeRecords(local, cloud){
      const map = new Map();
      (local||[]).forEach(r=> map.set(r.id || r.createdAt || JSON.stringify(r), r));
      (cloud||[]).forEach(r=>{
        const key = r.id || r.createdAt || JSON.stringify(r);
        if(map.has(key)){
          const existing = map.get(key);
          const aTime = tsToMillis(existing.updatedAt || existing.createdAt || '');
          const bTime = tsToMillis(r.updatedAt || r.createdAt || '');
          if(!aTime || (bTime && bTime > aTime)) map.set(key, r);
        } else map.set(key, r);
      });
      return Array.from(map.values()).sort((a,b)=> (b.createdAt||'').localeCompare(a.createdAt||''));
    }

    function scheduleCloudSave(){ if(window._pendingSave) clearTimeout(window._pendingSave); window._pendingSave = setTimeout(()=> writeCloud(), 700); }
    async function writeCloud(){ if(!auth.currentUser) return; const ref = db.doc('users/' + auth.currentUser.uid); try{ await ref.set({ profile:{ displayName: auth.currentUser.displayName || auth.currentUser.email }, records: records, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true }); }catch(e){ console.error(e); } }

    function startCloudListener(uid){ stopCloudListener(); const ref = db.doc('users/' + uid); cloudUnsub = ref.onSnapshot(snap=>{ if(!snap.exists) return; const data = snap.data() || {}; const cloud = data.records || []; records = mergeRecords(records || [], cloud || []); saveLocal(records); renderLists(); }, err=>console.error(err)); }
    function stopCloudListener(){ if(typeof cloudUnsub === 'function'){ cloudUnsub(); cloudUnsub = null; } }

    async function syncWithCloud(showToastOnSuccess = true){
      if(!auth.currentUser){ if(showToastOnSuccess) showToast('Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©'); return false; }
      try{
        const ref = db.doc('users/' + auth.currentUser.uid);
        const snap = await ref.get();
        const cloud = snap && snap.exists ? (snap.data().records || []) : [];
        records = mergeRecords(records || [], cloud);
        saveLocal(records);
        if(showToastOnSuccess) showToast('ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©');
        return true;
      }catch(err){ console.error('sync error', err); if(showToastOnSuccess) showToast('ÙØ´Ù„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©'); return false; }
    }

    function updateTotals(){
      let totalRemaining = 0;
      (records||[]).forEach(r=>{
        const paid = (r.payments||[]).reduce((s,p)=> s + Number(p.amount), 0);
        const totalAmount = Number(r.totalAmount||0);
        const down = Number(r.downPayment||0);
        const principal = Math.max(0, totalAmount - down);
        const remaining = Math.max(Math.round((principal - paid)*100)/100, 0);
        totalRemaining += remaining;
      });
      if($('totalRemainingAll')) $('totalRemainingAll').textContent = formatMoney(totalRemaining);
    }

    function updatePeopleCount(){
      const count = (records || []).length;
      if($('peopleCount')) $('peopleCount').textContent = count;
    }

    function renderLists(){
      const q = ($('search').value||'').trim();
      const tokens = getSearchTokens(q);

      const activeList = $('listActive'); activeList.innerHTML='';
      const activeArr = (records||[]).filter(r=> !isOverdueBy30(r) && recordMatches(r, tokens));
      $('emptyActive').style.display = activeArr.length ? 'none':'block';
      activeArr.forEach(r=>{
        const paid = (r.payments||[]).reduce((s,p)=> s + Number(p.amount),0);
        const principal = Math.max(0, Number(r.totalAmount||0) - Number(r.downPayment||0));
        const remaining = Math.max(Math.round((principal-paid)*100)/100,0);
        const nameHtml = highlightText(r.customerName || '', tokens.slice());
        const prodHtml = escapeHtml(r.productName || '');
        const phoneHtml = r.phone ? `<div class="phone">ğŸ“ ${escapeHtml(r.phone)}</div>` : '';

        const li=document.createElement('li'); li.className='item';
        li.innerHTML = `<div class="item-left">
            <div class="avatar">${escapeHtml((r.customerName||'--').split(' ').map(s=>s[0]).slice(0,2).join('').toUpperCase())}</div>
            <div class="meta">
              <div class="name">${nameHtml}</div>
              <div class="product">${prodHtml} ${r.officialPrice?(' â€” Ù†Ù‚Ø¯: '+formatMoney(r.officialPrice)):''}</div>
              ${phoneHtml}
              <div class="due-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</div>
              <div class="due-large">${escapeHtml(r.dueDate||'-')}</div>
            </div>
          </div>
          <div class="controls">
            <div style="text-align:left;margin-left:8px"><div class="amount">${formatMoney(remaining)}</div><div class="muted-small">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div></div>
            <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
              <div style="display:flex;gap:6px">
                <button data-id="${r.id}" data-action="view" class="btn-detail">ØªÙØ§ØµÙŠÙ„</button>
                <button data-id="${r.id}" data-action="edit" class="btn-ghost-small">ØªØ¹Ø¯ÙŠÙ„</button>
              </div>
              <button data-id="${r.id}" data-action="pay" class="btn-ghost-small">Ø¯ÙØ¹Ø©</button>
            </div>
          </div>`;
        activeList.appendChild(li);
      });

      const overdueList = $('listOverdue'); overdueList.innerHTML='';
      const overdueArr = (records||[]).filter(r=> isOverdueBy30(r) && recordMatches(r, tokens));
      $('emptyOverdue').style.display = overdueArr.length ? 'none':'block';
      overdueArr.forEach(r=>{
        const paid = (r.payments||[]).reduce((s,p)=> s + Number(p.amount),0);
        const principal = Math.max(0, Number(r.totalAmount||0) - Number(r.downPayment||0));
        const remaining = Math.max(Math.round((principal-paid)*100)/100,0);
        const nameHtml = highlightText(r.customerName || '', getSearchTokens($('search').value||''));
        const prodHtml = escapeHtml(r.productName || '');
        const phoneHtml = r.phone ? `<div class="phone">ğŸ“ ${escapeHtml(r.phone)}</div>` : '';

        const li=document.createElement('li'); li.className='item';
        li.innerHTML = `<div class="item-left">
            <div class="avatar" style="background:linear-gradient(135deg,#ff7a7a,#ff4d4d)">${escapeHtml((r.customerName||'--').split(' ').map(s=>s[0]).slice(0,2).join('').toUpperCase())}</div>
            <div class="meta">
              <div class="name" style="color:var(--danger)">${nameHtml}</div>
              <div class="product">${prodHtml} ${r.officialPrice?(' â€” Ù†Ù‚Ø¯: '+formatMoney(r.officialPrice)):''}</div>
              ${phoneHtml}
              <div class="due-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</div>
              <div class="due-large">${escapeHtml(r.dueDate||'-')}</div>
            </div>
          </div>
          <div class="controls">
            <div style="text-align:left;margin-left:8px"><div class="amount" style="color:var(--danger)">${formatMoney(remaining)}</div><div class="muted-small">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div></div>
            <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
              <div style="display:flex;gap:6px">
                <button data-id="${r.id}" data-action="view" class="btn-detail">ØªÙØ§ØµÙŠÙ„</button>
                <button data-id="${r.id}" data-action="edit" class="btn-ghost-small">ØªØ¹Ø¯ÙŠÙ„</button>
              </div>
              <button data-id="${r.id}" data-action="pay" class="btn-ghost-small">Ø¯ÙØ¹Ø©</button>
            </div>
          </div>`;
        overdueList.appendChild(li);
      });
      $('overdueCountHeader').textContent = overdueArr.length;
      saveLocal(records);
      updateTotals();
      updatePeopleCount();
    }

    // Delegated actions
    document.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button');
      if(!btn) return;
      const id = btn.dataset.id, action = btn.dataset.action;
      if(!action){
        if(btn.id === 'peopleBtn'){ showActiveTab(); return; }
        return;
      }
      if(action === 'view'){ openDetail(id); return; }
      if(action === 'pay'){ openDetail(id, true); return; }
      if(action === 'edit'){ openEdit(id); return; }
    });

    async function deleteRecordPermanent(id){
      if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹.')) return;
      const idx = records.findIndex(r=> r.id === id);
      if(idx !== -1) records.splice(idx,1);
      saveLocal(records);
      renderLists();
      await writeCloud();
      showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹');
    }

    // Add record
    $('btnAdd').addEventListener('click', async ()=>{
      if(!currentUser){ $('authBackdrop').style.display='flex'; showToast('Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹'); return; }
      const cust = $('custName').value.trim();
      const phone = $('custPhone').value.trim();
      const prod = $('prodName').value.trim();
      const cash = parseFloat($('totalAmt').value||0) || 0; // Ù†Ù‚Ø¯
      const installments = parseFloat($('officialPrice').value);
      const down = parseFloat($('downAmt').value||0);
      const due = $('dueDate').value || null;

      if(!cust || !prod || isNaN(installments) || installments <= 0){ alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­'); return; }
      if(down > installments){ alert('Ø§Ù„Ø¯ÙØ¹Ø© Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…Ø¨Ù„Øº'); return; }

      if(phone){
        const clean = phone.replace(/\s+/g,'');
        if(!/^\+?\d{7,15}$/.test(clean) && !/^0?5\d{8}$/.test(clean)){
          if(!confirm('ØµÙŠØºØ© Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± Ù…Ø£Ù„ÙˆÙØ©. Ø£Ø¶Ù Ø§Ù„Ø±Ù‚Ù… Ø¹Ù„Ù‰ Ø£ÙŠ Ø­Ø§Ù„ØŸ')) return;
        }
      }

      const rec = {
        id: genId(),
        customerName: cust,
        phone: phone || '',
        productName: prod,
        totalAmount: installments, // Ø£Ù‚Ø³Ø§Ø·
        officialPrice: cash,       // Ù†Ù‚Ø¯
        downPayment: down || 0,
        dueDate: due,
        payments: [],
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };
      records.unshift(rec); saveLocal(records);
      scheduleCloudSave();
      renderLists();
      $('custName').value=''; $('custPhone').value=''; $('prodName').value=''; $('totalAmt').value=''; $('officialPrice').value=''; $('downAmt').value=''; $('dueDate').value='';
      showToast('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©');
    });

    // Detail & payments
    function openDetail(id, focusPay=false){
      const r = records.find(x=> x.id === id); if(!r) return;
      activeDetailId = id;
      $('d_name').textContent = r.customerName;
      $('d_phone').textContent = r.phone || '-';
      $('d_product').textContent = r.productName;
      $('d_due').textContent = r.dueDate || '-';
      $('d_total').textContent = formatMoney(r.totalAmount);
      $('d_down').textContent = formatMoney(r.downPayment||0);
      $('d_official').textContent = r.officialPrice ? formatMoney(r.officialPrice) : '-';
      const paid = (r.payments||[]).reduce((s,p)=> s + Number(p.amount),0);
      const principal = Math.max(0, Number(r.totalAmount||0) - Number(r.downPayment||0));
      const remaining = Math.max(Math.round((principal-paid)*100)/100,0);
      $('d_remaining').textContent = formatMoney(remaining);
      const percent = principal>0? Math.round(((principal-remaining)/principal)*100):0;
      $('d_progress').style.width = Math.min(Math.max(percent,0),100) + '%';
      $('paymentsList').innerHTML = '';
      (r.payments||[]).slice().reverse().forEach(p=>{
        const div = document.createElement('div'); div.className='payment-item';
        div.innerHTML = `<div><strong>${formatMoney(p.amount)}</strong><div style="color:var(--muted)">${escapeHtml(p.date||'')}</div></div><div><button class="btn-ghost-small" data-payid="${p.id}">Ø­Ø°Ù</button></div>`;
        $('paymentsList').appendChild(div);
        div.querySelector('button').addEventListener('click', async ()=>{
          if(!confirm('Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙØ¹Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')) return;
          r.payments = (r.payments||[]).filter(pp=> pp.id !== p.id);
          r.updatedAt = new Date().toISOString();
          saveLocal(records);
          await writeCloud();
          openDetail(id); renderLists(); showToast('Ø­ÙØ°ÙØª Ø§Ù„Ø¯ÙØ¹Ø©');
        });
      });
      $('paymentsCount').textContent = (r.payments? r.payments.length:0) + ' Ø¯ÙØ¹Ø§Øª';
      $('payAmount').value = '';
      $('payDate').value = new Date().toISOString().slice(0,10);
      $('payWarning').style.display = 'none';
      $('detailBackdrop').style.display = 'flex';
      $('deleteRec').onclick = async ()=>{ await deleteRecordPermanent(activeDetailId); $('detailBackdrop').style.display = 'none'; }
      if(focusPay) setTimeout(()=> $('payAmount').focus(),160);
    }

    $('closeDetail').addEventListener('click', ()=> $('detailBackdrop').style.display = 'none');

    document.addEventListener('input', (e)=>{
      if(e.target && e.target.id === 'payAmount'){
        const val = parseFloat($('payAmount').value || '0');
        const rec = records.find(r=> r.id === activeDetailId);
        if(!rec){ $('payWarning').style.display='none'; return; }
        const paid = (rec.payments||[]).reduce((s,p)=> s + Number(p.amount),0);
        const principal = Math.max(0, Number(rec.totalAmount||0) - Number(rec.downPayment||0));
        const remaining = Math.max(Math.round((principal-paid)*100)/100,0);

        if(isNaN(val) || val <= 0){
          $('payWarning').textContent = 'Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„ØºØ§Ù‹ ØµØ­ÙŠØ­Ø§Ù‹';
          $('payWarning').style.display = 'block';
        } else if(val > remaining){
          $('payWarning').textContent = 'Ø§Ù„Ù…Ø¨Ù„Øº Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ';
          $('payWarning').style.display = 'block';
        } else {
          $('payWarning').style.display = 'none';
        }
      }
    });

    $('savePay').addEventListener('click', async ()=>{
      if(!activeDetailId) return;
      const amt = parseFloat($('payAmount').value); if(isNaN(amt)||amt<=0){ alert('Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„ØºØ§Ù‹ ØµØ­ÙŠØ­Ø§Ù‹'); return; }
      const rec = records.find(r=> r.id === activeDetailId); if(!rec) return;
      const paid = (rec.payments||[]).reduce((s,p)=> s + Number(p.amount),0);
      const principal = Math.max(0, Number(rec.totalAmount||0) - Number(rec.downPayment||0));
      const remaining = Math.max(Math.round((principal-paid)*100)/100,0);

      if(amt > remaining){
        alert('Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø°ÙŠ ØªØ­Ø§ÙˆÙ„ Ø¥Ø¶Ø§ÙØªÙ‡ Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ. Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø£Ùˆ Ø§Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©.');
        return;
      }

      const date = $('payDate').value || new Date().toISOString().slice(0,10);
      rec.payments = rec.payments || []; rec.payments.push({ id:'p_'+Date.now(), amount: Math.round(amt*100)/100, date });
      rec.updatedAt = new Date().toISOString();

      saveLocal(records);
      await writeCloud();
      renderLists(); openDetail(activeDetailId); showToast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙØ¹Ø©');
    });

    // Edit functions
    function openEdit(id){
      const r = records.find(x=> x.id === id); if(!r) return;
      editingId = id;
      // populate fields (respect swapped semantics: editTotalAmt => Ù†Ù‚Ø¯ => officialPrice)
      $('editCustName').value = r.customerName || '';
      $('editCustPhone').value = r.phone || '';
      $('editProdName').value = r.productName || '';
      $('editTotalAmt').value = r.officialPrice || '';
      $('editOfficialPrice').value = r.totalAmount || '';
      $('editDownAmt').value = r.downPayment || '';
      $('editDueDate').value = r.dueDate || '';
      // close detail if open
      $('detailBackdrop').style.display = 'none';
      $('editBackdrop').style.display = 'flex';
    }

    function closeEditModal(){
      editingId = null;
      $('editBackdrop').style.display = 'none';
    }

    $('closeEdit').addEventListener('click', closeEditModal);
    $('cancelEdit').addEventListener('click', closeEditModal);

    $('saveEdit').addEventListener('click', async ()=>{
      if(!editingId) return;
      const rec = records.find(r=> r.id === editingId); if(!rec) return;
      const cust = $('editCustName').value.trim();
      const phone = $('editCustPhone').value.trim();
      const prod = $('editProdName').value.trim();
      const cash = parseFloat($('editTotalAmt').value||0) || 0; // Ù†Ù‚Ø¯ => officialPrice
      const installments = parseFloat($('editOfficialPrice').value);
      const down = parseFloat($('editDownAmt').value||0);
      const due = $('editDueDate').value || null;

      if(!cust || !prod || isNaN(installments) || installments <= 0){ alert('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­'); return; }
      if(down > installments){ alert('Ø§Ù„Ø¯ÙØ¹Ø© Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…Ø¨Ù„Øº'); return; }

      rec.customerName = cust;
      rec.phone = phone || '';
      rec.productName = prod;
      rec.officialPrice = cash;
      rec.totalAmount = installments;
      rec.downPayment = down || 0;
      rec.dueDate = due;
      rec.updatedAt = new Date().toISOString();

      saveLocal(records);
      await writeCloud();
      renderLists();
      closeEditModal();
      showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª');
    });

    // Auth and misc handlers
    $('togglePassword').addEventListener('click', ()=>{
      const p = $('loginPassword'); p.type = p.type === 'password' ? 'text' : 'password';
      $('togglePassword').textContent = p.type === 'password' ? 'ğŸ‘' : 'ğŸ™ˆ';
    });
    $('rememberMe').addEventListener('change', (e)=>{ const mode = e.target.checked ? firebase.auth.Auth.Persistence.LOCAL : firebase.auth.Auth.Persistence.SESSION; auth.setPersistence(mode).catch(()=>{}); });

    $('doLogin').addEventListener('click', async ()=>{
      showAuthError('');
      const email = $('loginEmail').value.trim(), pass = $('loginPassword').value;
      if(!email || !pass){ showAuthError('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹'); return; }
      const btn = $('doLogin'); const prev = btn.textContent; btn.textContent = '...Ø¬Ø§Ø±Ù Ø§Ù„Ø¯Ø®ÙˆÙ„'; btn.disabled = true;
      try{ await auth.signInWithEmailAndPassword(email, pass); showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'); } catch(err){ console.error(err); showAuthError((err.code||'') + ' â€” ' + (err.message||'')); } finally{ btn.disabled = false; btn.textContent = prev; }
    });

    $('openRegister').addEventListener('click', ()=> { $('registerBackdrop').style.display = 'flex'; });
    $('closeRegister').addEventListener('click', ()=> { $('registerBackdrop').style.display = 'none'; });

    $('doRegister').addEventListener('click', async ()=>{
      showRegError(''); showRegInfo('');
      const email = $('regEmail').value.trim();
      const display = $('regDisplayName').value.trim();
      const pass = $('regPassword').value;
      const pass2 = $('regPassword2').value;
      if(!email || !pass || !pass2){ showRegError('Ø£ÙƒÙ…Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„'); return; }
      if(pass.length < 6){ showRegError('ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„'); return; }
      if(pass !== pass2){ showRegError('ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ÙˆØªØ£ÙƒÙŠØ¯Ù‡Ø§ ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ÙŠÙ†'); return; }
      const btn = $('doRegister'); btn.disabled = true; const prev = btn.textContent; btn.textContent = '...Ø¬Ø§Ø±Ù Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡';
      try{
        const cred = await auth.createUserWithEmailAndPassword(email, pass);
        if(cred && cred.user && display){
          try{ await cred.user.updateProfile({ displayName: display }); }catch(e){ console.warn('updateProfile', e); }
        }
        showRegInfo('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
        setTimeout(()=>{ $('registerBackdrop').style.display = 'none'; }, 700);
      }catch(err){
        console.error(err);
        const msg = err && err.code ? (err.code + ' â€” ' + (err.message||'')) : (err.message||'ÙØ´Ù„ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡');
        showRegError(msg);
      }finally{
        btn.disabled = false; btn.textContent = prev;
      }
    });

    $('forgotPassword').addEventListener('click', async ()=>{
      const email = $('loginEmail').value.trim() || prompt('Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†:');
      if(!email){ showAuthError('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø£ÙˆÙ„Ø§Ù‹'); return; }
      try{ await auth.sendPasswordResetEmail(email); showToast('Ø£ÙØ±Ø³Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±'); }catch(err){ console.error(err); showAuthError(err.message||'ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø·'); }
    });

    $('btnOpenAuth').addEventListener('click', ()=> $('authBackdrop').style.display = 'flex');
    $('btnLogout').addEventListener('click', async ()=>{ if(!confirm('ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ØŸ')) return; try{ await auth.signOut(); showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬'); }catch(e){ console.error(e); showToast('Ø®Ø·Ø£'); } });

    function showActiveTab(){ $('tabActive').classList.add('active'); $('tabOverdue').classList.remove('active'); $('listActive').style.display='block'; $('listOverdue').style.display='none'; }
    function showOverdueTab(){ $('tabOverdue').classList.add('active'); $('tabActive').classList.remove('active'); $('listOverdue').style.display='block'; $('listActive').style.display='none'; }
    $('tabActive').addEventListener('click', showActiveTab); $('tabOverdue').addEventListener('click', showOverdueTab);
    $('tabActive').addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); showActiveTab(); }});
    $('tabOverdue').addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); showOverdueTab(); }});

    auth.onAuthStateChanged(async (user)=>{
      if(user){
        currentUser = { uid:user.uid, email:user.email, name:user.displayName || (user.email||'').split('@')[0] };
        $('userPill').textContent = currentUser.name;
        $('btnLogout').style.display = 'inline-block';
        $('btnOpenAuth').style.display = 'none';
        $('authBackdrop').style.display = 'none';
        $('mainPanel').style.display = 'block';
        startCloudListener(user.uid);
        await syncWithCloud(false);
      } else {
        currentUser = null;
        $('userPill').textContent = 'ØºÙŠØ± Ù…Ø³Ø¬Ù„';
        $('btnLogout').style.display = 'none';
        $('btnOpenAuth').style.display = 'inline-block';
        $('authBackdrop').style.display = 'flex';
        $('mainPanel').style.display = 'none';
        stopCloudListener();
      }
      renderLists();
    });

    (function removeSeededDemoClients(){ const seededNames=['Ø³Ø§Ø±Ø© Ø£Ø­Ù…Ø¯','Ù…Ø­Ù…ÙˆØ¯ Ø¹Ù„ÙŠ','Ù„ÙŠÙ„Ù‰ Ø­Ø³Ù†']; const prevLen = records.length; records = records.filter(r => !seededNames.includes(r.customerName)); if(records.length !== prevLen){ saveLocal(records); showToast('Ø£Ø²ÙŠÙ„Øª Ø¹ÙŠÙ‘Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©'); } })();

    // initial
    renderLists();

    const debouncedRender = debounce(renderLists, 120);
    $('search').addEventListener('input', debouncedRender);
    $('searchBtn').addEventListener('click', renderLists);

    window.addEventListener('storage', (e)=>{ if(e.key === KEY){ records = loadLocal(); renderLists(); } });

    document.querySelectorAll('.backdrop').forEach(b => {
      b.addEventListener('click', (e)=>{
        if(e.target !== b) return;
        if(b.id === 'authBackdrop') return;
        b.style.display = 'none';
      });
      b.querySelectorAll('.modal').forEach(m => m.addEventListener('click', ev => ev.stopPropagation()));
    });

    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape'){
        if($('detailBackdrop') && $('detailBackdrop').style.display === 'flex') $('detailBackdrop').style.display = 'none';
        if($('registerBackdrop') && $('registerBackdrop').style.display === 'flex') $('registerBackdrop').style.display = 'none';
        if($('editBackdrop') && $('editBackdrop').style.display === 'flex') closeEditModal();
      }
    });

    setTimeout(()=> { if($('loginEmail')) $('loginEmail').focus(); }, 400);
  </script>
</body>
</html>
